name: Deploy Vite React to EC2 (Git Pull on EC2)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Deploy on EC2 (git pull -> build -> deploy)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            set -e

            # 1) (서버에 소스가 없으면) 최초 1회 clone 후 이후부터는 pull
            APP_DIR=/home/ubuntu/vite-react-app
            REPO_URL="https://github.com/kimjoy0914/react-docker1.git"

            if [ ! -d "$APP_DIR/.git" ]; then
              sudo mkdir -p $APP_DIR
              sudo chown -R $USER:$USER $APP_DIR
              git clone $REPO_URL $APP_DIR
            fi

            cd $APP_DIR

            # 2) 최신 코드 받기
            git checkout main
            git pull origin main

            # 3) 의존성 설치 + 빌드
            npm ci
            npm run build

            # 4) dist -> Nginx 배포 경로로 반영
            sudo rm -rf /var/www/vite-app/*
            sudo cp -r dist/* /var/www/vite-app/

            # 5) Nginx 설정 체크 + reload
            sudo nginx -t
            sudo systemctl reload nginx

            echo "✅ Deploy done (git pull on EC2)"
